<link rel="import" href="../polymer/polymer.html">

<!-- paper elements -->
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<!-- icons -->
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-image/iron-image.html">

<!-- animations -->
<link rel="import" href="../neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="../neon-animation/animations/slide-left-animation.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">

<!--
Youtube button element that launches a modal playing the video

Example:

    <featured-articles></featured-articles>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="featured-articles">
  <template>
    <style include="iron-flex iron-flex-factors iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        font-family: "Roboto";
      }

      :host a {
        color:inherit;
        text-decoration: none;
      }

      :host * {
        box-sizing: border-box;
      }

      .featured-article {
        padding: 24px;
      }

      #featuredArticlesContainer {
        overflow: hidden;
      }

      .featured-articles-header {
        background: #003b64;
        z-index: 10;
      }
      .featured-articles-items {
        z-index: 1;
      }
      .featured-articles .featured-articles-header {
        padding: 256px 24px 24px;
        position: relative;
      }
      .featured-articles .featured-articles-header-title {
        color: #fff200;
        margin-bottom: 24px;
      }
      .featured-articles .featured-articles-header-description {
        margin-bottom: 40px;
      }
      .core-utilities .bby-style-wrapper .loose {
        line-height: 180%;
      }
      .featured-articles .featured-articles-header-link {
        bottom: 24px;
        position: absolute;
      }
      .core-utilities .bby-style-wrapper .colour-yellow {
        color: #fff200;
      }
      .featured-article-image {
        height: 200px;
        width: 100%;
      }
    </style>

    <iron-ajax auto id="ajax" url="http://test-plug-in-blog.pantheonsite.io/plugin-blog/wp-json/wp/v2/posts" params='{{params}}' handle-as="json" loading="{{loading}}" on-response="addArticlesPage" last-response="{{articlesDataResponse}}"></iron-ajax>

    <template is="dom-if" if="{{loading}}">
      <div class="container flex-horizontal">
        <div class="flexchild"></div>
        <paper-spinner active></paper-spinner>
        <div class="flexchild"></div>
      </div>
    </template>

    <div id="featuredArticlesContainer" class="layout horizontal">
      <a href="#" aria-label="Read our blogs" class="featured-articles-header flex-3" data-equalizer-watch="blog-posts" style="height: 456px;">
        <div class="featured-articles-header-title">
          Featured article from the blog
        </div>
      </a>
      <div class="featured-articles-items flex-9 layout horizontal">
        <neon-animated-pages id="pages" class="flex-12" entry-animation="slide-from-right-animation" exit-animation="slide-left-animation" selected="[[articlesPageIndex]]" class="layout horizontal">
          <template is="dom-repeat" items="[[articlesPages]]" as="page">
          <div class="articles-page flex layout horizontal">
            <template is="dom-repeat" items="[[page]]" as="article">
              <a href="{{article.link}}" class="flex self-stretch layout horizontal">
                <paper-card class="flex self-stretch featured-article">
                  <iron-image class="featured-article-image" sizing="cover" preload fade src="[[article.better_featured_image.media_details.sizes.medium.source_url]]"></iron-image>
                  <h3 data-equalizer="featured-article-heading" class="featured-article-heading open-sans-semi-bold black">[[article.title.rendered]]</h3>
                  <p class="featured-article-author black font-xxs">by [[article.post_author.first_name]] [[article.post_author.last_name]]<br>
                  on <time>{{getFormattedDate(article.date)}}</time></p>
                  <span class="featured-article-button button-outline button-blue">Learn More</span>
                </paper-card>
              </a>
            </template>
            </div>
          </template>
        </neon-animated-pages>
      </div>
    </div>
    <paper-button on-tap="nextPage">More articles</paper-button>
  </template>

  <script>
    Polymer({
      is: 'featured-articles',

      properties: {
        params: {
          type: Object,
          value: {}
        },

        articlesDataResponse: {
          type: Object
        },

        articlesPages: {
          type: Array,
          value: []
        },

        displayedArticleCount: {
          type: String,
          value: 3
        },

        searchQuery: {
          type: Object,
          value: {}
        },

        articlesPageIndex: {
          type: Number,
          value: -1
        },

        wpPageIndex: {
          type: Number,
          value: 1,
          observer: "_setParams"
        }
      },

      // Element Lifecycle
      ready: function() {
      },

      addArticlesPage: function () {
        this.push('articlesPages',this.articlesDataResponse);
        this.articlesPageIndex += 1;
      },

      attached: function() {

      },

      _setParams: function() {
        var allowedSearchQueryParams = ["search", "categories", "tags"];
        var paramsObject = {
          per_page: this.displayedArticleCount,
          page: this.wpPageIndex
        };

        //Add as query parameter only allowed attributes from the searchQuery object
        for (var searchQueryParam in this.searchQuery) {
          if (allowedSearchQueryParams.indexOf(searchQueryParam) != -1) {
            paramsObject[searchQueryParam] = this.searchQuery[searchQueryParam];
          }
        }
        this.params = paramsObject;
      },

      nextPage: function () {
        this.wpPageIndex += 1;
      },

      getFormattedDate: function (timeString) {
        var date = new Date(timeString);
        return date.getMonth()+1 + "-" + date.getDate() + "-" + date.getFullYear();
      }
    });
  </script>
</dom-module>
